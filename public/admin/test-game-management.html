<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Game Management Functions - Century Pong</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .test-section {
            background: rgba(0, 0, 0, 0.7);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(255, 165, 0, 0.3);
        }
        .test-section h3 {
            color: #ff6b35;
            margin-top: 0;
            margin-bottom: 1rem;
        }
        .test-input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.5);
            border-radius: 0.25rem;
            color: white;
        }
        .test-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .test-button {
            background: #ff6b35;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: bold;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        .test-button:hover {
            background: #ff8c5a;
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .result-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 1rem;
            border-radius: 0.25rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .result-success {
            border: 2px solid #4caf50;
            color: #4caf50;
        }
        .result-error {
            border: 2px solid #f44336;
            color: #f44336;
        }
        .result-info {
            border: 2px solid #2196f3;
            color: #2196f3;
        }
        .info-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
        .loading {
            color: #ff6b35;
            font-style: italic;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen">
    <div class="page-wrapper max-w-6xl">
        <header class="page-header">
            <h1 class="text-4xl">
                <span class="page-title">Test Game Management Functions</span>
            </h1>
            <p class="info-text">Use this page to verify Phase 5 game management functions are working correctly.</p>
        </header>

        <!-- Test 1: getGameById -->
        <div class="test-section">
            <h3>1. Test getGameById()</h3>
            <p class="info-text">Fetch a game by ID and display its data structure.</p>
            <input type="text" id="get-game-id" class="test-input" placeholder="Enter game ID...">
            <button class="test-button" onclick="testGetGameById()">Get Game</button>
            <div id="get-game-result" class="result-box hidden"></div>
        </div>

        <!-- Test 2: recalculatePlayerStatsForPlayers -->
        <div class="test-section">
            <h3>2. Test recalculatePlayerStatsForPlayers()</h3>
            <p class="info-text">Recalculate stats for one or more players. Enter comma-separated player names.</p>
            <input type="text" id="recalc-players" class="test-input" placeholder="Enter player names (comma-separated)...">
            <button class="test-button" onclick="testRecalculateStats()">Recalculate Stats</button>
            <div id="recalc-result" class="result-box hidden"></div>
        </div>

        <!-- Test 3: updateGame -->
        <div class="test-section">
            <h3>3. Test updateGame()</h3>
            <p class="info-text">Update an existing game. First fetch a game, then modify the JSON below and click Update.</p>
            <input type="text" id="update-game-id" class="test-input" placeholder="Enter game ID to update...">
            <button class="test-button" onclick="loadGameForUpdate()">Load Game</button>
            <textarea id="update-game-data" class="test-input" rows="15" placeholder="Game data JSON will appear here after loading..."></textarea>
            <button class="test-button" onclick="testUpdateGame()" id="update-game-btn" disabled>Update Game</button>
            <div id="update-result" class="result-box hidden"></div>
        </div>

        <!-- Test 4: deleteGame -->
        <div class="test-section">
            <h3>4. Test deleteGame()</h3>
            <p class="info-text warning">‚ö†Ô∏è WARNING: This will permanently delete a game and all its data!</p>
            <input type="text" id="delete-game-id" class="test-input" placeholder="Enter game ID to delete...">
            <button class="test-button" onclick="testDeleteGame()" style="background: #f44336;">Delete Game</button>
            <div id="delete-result" class="result-box hidden"></div>
        </div>

        <!-- Test 5: Quick Test Suite -->
        <div class="test-section">
            <h3>5. Quick Test Suite</h3>
            <p class="info-text">Run all tests in sequence. Make sure you have at least one game in the database first.</p>
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
            <div id="suite-result" class="result-box hidden"></div>
        </div>

        <div class="back-button-container">
            <a href="../home.html" class="nav-button">Back to Home</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Firebase Config -->
    <script src="../js/firebase-config.js"></script>

    <!-- Initialize Firebase -->
    <script>
        firebase.initializeApp(window.firebaseConfig);
        window.db = firebase.firestore();
        window.storage = firebase.storage();
    </script>

    <!-- Firebase Service -->
    <script src="../js/firebase-service.js"></script>

    <!-- Test Script -->
    <script>
        // Helper function to show result
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result-box result-${type}`;
            element.classList.remove('hidden');
        }

        // Helper function to show loading
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.textContent = 'Loading...';
            element.className = 'result-box loading';
            element.classList.remove('hidden');
        }

        // Test 1: getGameById
        async function testGetGameById() {
            const gameId = document.getElementById('get-game-id').value.trim();
            if (!gameId) {
                showResult('get-game-result', 'Please enter a game ID', 'error');
                return;
            }

            showLoading('get-game-result');
            try {
                const game = await window.ceepsAPI.getGameById(gameId);
                const result = JSON.stringify(game, null, 2);
                showResult('get-game-result', `‚úÖ Success!\n\n${result}`, 'success');
            } catch (error) {
                showResult('get-game-result', `‚ùå Error: ${error.message}\n\n${error.stack}`, 'error');
            }
        }

        // Test 2: recalculatePlayerStatsForPlayers
        async function testRecalculateStats() {
            const playersInput = document.getElementById('recalc-players').value.trim();
            if (!playersInput) {
                showResult('recalc-result', 'Please enter player names', 'error');
                return;
            }

            const playerNames = playersInput.split(',').map(p => p.trim()).filter(p => p);
            if (playerNames.length === 0) {
                showResult('recalc-result', 'Please enter at least one valid player name', 'error');
                return;
            }

            showLoading('recalc-result');
            try {
                const result = await window.ceepsAPI.recalculatePlayerStatsForPlayers(playerNames);
                showResult('recalc-result', `‚úÖ Success!\n\nRecalculated stats for ${result.playersRecalculated} player(s):\n${playerNames.join(', ')}`, 'success');
            } catch (error) {
                showResult('recalc-result', `‚ùå Error: ${error.message}\n\n${error.stack}`, 'error');
            }
        }

        // Test 3: updateGame - Load game first
        async function loadGameForUpdate() {
            const gameId = document.getElementById('update-game-id').value.trim();
            if (!gameId) {
                showResult('update-result', 'Please enter a game ID', 'error');
                return;
            }

            showLoading('update-result');
            try {
                const game = await window.ceepsAPI.getGameById(gameId);
                // Format game data for editing (remove id, created_at)
                const gameData = {
                    date: game.date,
                    team1: game.team1,
                    team2: game.team2,
                    winner: game.winner,
                    team1_score: game.team1_score,
                    team2_score: game.team2_score,
                    scorecard_player: game.scorecard_player,
                    individual_stats: game.individual_stats
                };
                document.getElementById('update-game-data').value = JSON.stringify(gameData, null, 2);
                document.getElementById('update-game-btn').disabled = false;
                showResult('update-result', `‚úÖ Game loaded! Modify the JSON above and click Update Game.`, 'success');
            } catch (error) {
                showResult('update-result', `‚ùå Error loading game: ${error.message}`, 'error');
            }
        }

        // Test 3: updateGame - Update game
        async function testUpdateGame() {
            const gameId = document.getElementById('update-game-id').value.trim();
            if (!gameId) {
                showResult('update-result', 'Please enter a game ID', 'error');
                return;
            }

            const gameDataText = document.getElementById('update-game-data').value.trim();
            if (!gameDataText) {
                showResult('update-result', 'Please load a game first', 'error');
                return;
            }

            let gameData;
            try {
                gameData = JSON.parse(gameDataText);
            } catch (error) {
                showResult('update-result', `‚ùå Invalid JSON: ${error.message}`, 'error');
                return;
            }

            showLoading('update-result');
            try {
                const result = await window.ceepsAPI.updateGame(gameId, gameData);
                showResult('update-result', `‚úÖ Success! Game updated.\n\nGame ID: ${result.game_id}`, 'success');
            } catch (error) {
                showResult('update-result', `‚ùå Error: ${error.message}\n\n${error.stack}`, 'error');
            }
        }

        // Test 4: deleteGame
        async function testDeleteGame() {
            const gameId = document.getElementById('delete-game-id').value.trim();
            if (!gameId) {
                showResult('delete-result', 'Please enter a game ID', 'error');
                return;
            }

            if (!confirm(`‚ö†Ô∏è WARNING: This will permanently delete game ${gameId} and all its data!\n\nAre you sure you want to continue?`)) {
                return;
            }

            showLoading('delete-result');
            try {
                const result = await window.ceepsAPI.deleteGame(gameId);
                showResult('delete-result', `‚úÖ Success! Game deleted.\n\n${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                showResult('delete-result', `‚ùå Error: ${error.message}\n\n${error.stack}`, 'error');
            }
        }

        // Test 5: Run all tests
        async function runAllTests() {
            const resultElement = document.getElementById('suite-result');
            resultElement.textContent = 'Running test suite...\n';
            resultElement.className = 'result-box result-info';
            resultElement.classList.remove('hidden');

            const log = (message) => {
                resultElement.textContent += message + '\n';
                resultElement.scrollTop = resultElement.scrollHeight;
            };

            try {
                // Test 1: Get recent games to find a game ID
                log('üìã Step 1: Fetching recent games to find a test game...');
                const recentGames = await window.ceepsAPI.getRecentGames(1);
                if (recentGames.length === 0) {
                    log('‚ùå No games found in database. Please create at least one game first.');
                    return;
                }
                const testGameId = recentGames[0].id;
                log(`‚úÖ Found test game: ${testGameId}`);

                // Test 2: getGameById
                log('\nüìã Step 2: Testing getGameById()...');
                const game = await window.ceepsAPI.getGameById(testGameId);
                log(`‚úÖ getGameById() works! Game date: ${game.date}`);
                log(`   - Team 1: ${game.team1.join(', ')}`);
                log(`   - Team 2: ${game.team2.join(', ')}`);
                log(`   - Winner: ${game.winner}`);
                log(`   - Individual stats: ${Object.keys(game.individual_stats || {}).length} players`);

                // Test 3: Get players from the game
                log('\nüìã Step 3: Getting players from game...');
                const allPlayers = [...game.team1, ...game.team2].filter(p => p !== 'Guest');
                if (allPlayers.length === 0) {
                    log('‚ö†Ô∏è  No non-Guest players in this game. Skipping recalculation test.');
                } else {
                    const testPlayer = allPlayers[0];
                    log(`‚úÖ Testing with player: ${testPlayer}`);

                    // Test 4: recalculatePlayerStatsForPlayers
                    log('\nüìã Step 4: Testing recalculatePlayerStatsForPlayers()...');
                    const recalcResult = await window.ceepsAPI.recalculatePlayerStatsForPlayers([testPlayer]);
                    log(`‚úÖ recalculatePlayerStatsForPlayers() works! Recalculated ${recalcResult.playersRecalculated} player(s)`);

                    // Test 5: Verify stats were recalculated
                    log('\nüìã Step 5: Verifying stats were recalculated...');
                    const playerStats = await window.ceepsAPI.getPlayerStats(testPlayer);
                    log(`‚úÖ Player stats retrieved:`);
                    log(`   - Games played: ${playerStats.games_played}`);
                    log(`   - Games won: ${playerStats.games_won}`);
                    log(`   - Win ratio: ${playerStats.win_ratio.toFixed(2)}`);
                    log(`   - Cups hit avg: ${playerStats.cups_hit_avg.toFixed(2)}`);
                }

                // Test 6: updateGame (just verify it doesn't error, don't actually update)
                log('\nüìã Step 6: Testing updateGame() structure (dry run)...');
                const gameDataForUpdate = {
                    date: game.date,
                    team1: game.team1,
                    team2: game.team2,
                    winner: game.winner,
                    team1_score: game.team1_score,
                    team2_score: game.team2_score,
                    scorecard_player: game.scorecard_player,
                    individual_stats: game.individual_stats
                };
                log(`‚úÖ updateGame() data structure validated`);
                log(`   - All required fields present`);
                log(`   - Individual stats: ${Object.keys(gameDataForUpdate.individual_stats).length} players`);
                log(`   ‚ö†Ô∏è  Skipping actual update to preserve data. Use Test 3 to test updates.`);

                // Test 7: deleteGame (just verify structure, don't actually delete)
                log('\nüìã Step 7: Testing deleteGame() structure (dry run)...');
                log(`‚úÖ deleteGame() structure validated`);
                log(`   ‚ö†Ô∏è  Skipping actual deletion to preserve data. Use Test 4 to test deletions.`);

                log('\n‚úÖ All tests passed!');
                log('\nüìù Summary:');
                log('   - getGameById() ‚úÖ');
                log('   - recalculatePlayerStatsForPlayers() ‚úÖ');
                log('   - updateGame() structure ‚úÖ');
                log('   - deleteGame() structure ‚úÖ');
                log('\nüí° Note: updateGame() and deleteGame() were not executed to preserve your data.');
                log('   Use the individual test sections above to test those functions with specific game IDs.');

            } catch (error) {
                log(`\n‚ùå Test suite failed: ${error.message}`);
                log(`\nStack trace:\n${error.stack}`);
                resultElement.className = 'result-box result-error';
            }
        }

        // Allow Enter key to submit
        document.getElementById('get-game-id').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') testGetGameById();
        });
        document.getElementById('recalc-players').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') testRecalculateStats();
        });
        document.getElementById('delete-game-id').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') testDeleteGame();
        });
    </script>
</body>
</html>

